%\VignetteIndexEntry{flexsurv user guide}

%% TODO 
%% What examples of custom dist? llogis? tobit example in help(survreg)?  Walter's model
%% spline with haz as fn of time
%% fractional polynomials


\documentclass[nojss,nofooter]{jss}
\usepackage{bm}
\usepackage{tabularx}

\author{Christopher H. Jackson \\ MRC Biostatistics Unit, Cambridge, UK \\ \email{chris.jackson@mrc-bsu.cam.ac.uk}}
\title{flexsurv: flexible parametric survival modelling in R}

\Abstract{ \pkg{flexsurv} is an R package for fully-parametric modelling of 
  survival data.  Any parametric time-to-event distribution
  may be fitted if the user supplies at minimum a probability density
  or hazard function.  Many standard survival distributions are built
  in, and also the three and four-parameter generalized gamma and F
  models.  Any parameter of the distribution can be modelled as a
  linear or log-linear function of covariates.  Another built-in model
  is the spline model of Royston and Parmar, in which both baseline
  survival and covariate effects can be arbitrarily flexible
  parametric functions of time.

  Any output function
  
  The main model-fitting function, \code{flexsurvreg}, uses the
  familiar syntax of \code{survreg} from the standard \pkg{survival}
  package --- censoring or left-truncation are specified in
  \code{Surv} objects.  \pkg{flexsurv} also enhances the \pkg{mstate}
  package (Putter et al) by providing cumulative incidences for
  fully-parametric multi-state models.  }
%\Keywords{survival}

\begin{document}

\section{Motivation and design}

The Cox model is ubiquitous in medical research, since the effects of
predictors of survival can be estimated without needing to supply a
baseline survival distribution that might be wrong.  However,
fully-parametric models have many advantages, and even the originator
of the Cox model has expressed a preference for parametric modelling
\citep{reid:cox:conversation}.  Fully-specified models help to
understand the change in hazard through time, and help with prediction
and extrapolation. For example, the mean survival $E(T) =
\int_0^{\infty}S(t)$, used in health economic
evaluations \citep{latimer2013survival}, needs the survivor function
$S(t)$ to be fully-specified for all times $t$.

%% Cox "That's right, but since then various people have shown that
%% the answers are very insensitive to the parametric
%% formulation of the underlying distribution. And if you want
%% to do things like predict the outcome for a particular patient,
%% it's much more convenient to do that parametrically."

\pkg{flexsurv} allows parametric distributions of
arbitrary complexity to be fitted to survival data, gaining the
convenience of parametric modelling, while avoiding the risk of model
misspecification.  Built-in choices include splines with any number of
knots \citep{royston:parmar} and 3--4 parameter generalized gamma and
F distribution families.  Any user-defined model may be employed by
supplying at minimum an R function to compute the probability density
or hazard, and ideally also its cumulative form.  Any parameters may
be modelled in terms of covariates, and any function of the parameters
may be printed or plotted in model summaries.

\pkg{flexsurv} is intended as a general platform for survival
modelling in R.  It is similar in spirit to the Stata packages
\pkg{stpm2} \citep{stpm2} for spline-based survival modelling, and
\pkg{stgenreg} \citep{stgenreg} for fitting survival models with
user-defined hazard functions using numerical integration. The
\code{survreg} function in the R package \pkg{survival} only supports
two-parameter (location/scale) distributions, though users can supply
their own distributions if they can be parameterised in this form.
Many other contributed R packages can fit survival models,
e.g. \pkg{eha} \citep{eha}, \pkg{VGAM} \citep{yee:wild}, though these
are either limited to specific distribution families not specifically
designed for survival analysis, or (\pkg{ActuDistns},
\citet{ActuDistns}) contain only the definitions of distribution
functions.  \pkg{flexsurv} enables distribution functions provided by
such packages to be employed in models.  An advantage over
\pkg{stgenreg} is that numerical integration can be avoided if the
analytic cumulative distribution or hazard can be supplied, and
optimisation can also be speeded by supplying analytic derivatives.
\pkg{flexsurv} also has features for multi-state modelling and
interval censoring, and general output reporting.  It employs
functional programming to work with user-defined or existing R
functions.



\section{General parametric survival model}

\subsection{Definitions} 

The general model that \pkg{flexsurv} fits has probability density function
\begin{equation}
  \label{eq:model}
  f(t | \mu(\mathbf{z}), \bm{\alpha}(\mathbf{z})), \quad t \geq 0  
\end{equation}

$\mu=\alpha_0$ is the parameter of primary interest,
which usually governs the mean or location of the distribution.  Other
parameters $\bm{\alpha} = \alpha_1, \ldots, \alpha_R$ are called
``ancillary'' and determine the shape, variance or higher moments.
All parameters may depend on a vector of covariates $\mathbf{z}$
through link-transformed linear models $g_0(\mu) = \bm{\beta}_0^{'}
\mathbf{z}$ and $g_r(\alpha_r) = \bm{\beta}_r^{'} \mathbf{z}$. $g(x)$ will
typically be $\log(x)$ if $x$ is defined to be positive, or $g(x)=x$
if $x$ is unrestricted.  In all models, $\bm{\beta}$ includes at 
least an intercept, so that the full set of parameters is given by 
$\{\bm{\beta}_r: r=1,\ldots,R$.
PROPORTIONAL HAZARDS / ACCELERATED FAILURE TIME

We also define (suppressing the conditioning for clarity) the
cumulative distribution function $F(t)$, survivor function $S(t) = 1 -
F(t)$, cumulative hazard $H(t) = -\log S(t)$ and hazard $h(t) =
f(t)/S(t)$.

Let $t_i: i=1,\ldots, n$ be a sample of times from individuals $i$.
Let $c_i=1$ if $t_i$ is an observed death time, or $c_i=0$ if $t_i$ is
a right-censoring time, thus the true death time is known only to be
greater than $t_i$.  Also let $s_i$ be corresponding left-truncation
(or delayed-entry) times, meaning that individual $i$ is only observed
conditionally on having survived up to $s_i$, thus $s_i=0$ if there is
no left-truncation.  Additionally let $t^{max}_i$ be left-censoring
times.  If there is no left-censoring then these are infinite, so that
$S(t^{max}_i)=0$; or if the $i$th death time is interval-censored then
$c_i=0$ and $t^{max}_i$ is finite.

The likelihood for the parameters $\bm{\beta}$ in model
(\ref{eq:model}), given the corresponding data vectors, is
\begin{equation}
  \label{eq:lik}
  l(\{\bm{\beta}_r\} | \mathbf{t},\mathbf{c},\mathbf{s},\mathbf{t}^{max}) = \left\{ \prod_{i:\ c_i=1} f_i(t_i) \prod_{i:\ c_i=0} \left(S_i(t_i) - S_i(t^{max}_i)\right)\right\} / \prod_i S_i(s_i)  
\end{equation}

Note that the individuals are independent, so that \pkg{flexsurv} does not
currently support frailty, clustered or random effects models.

EXAMPLE DATASET HERE.  bc?  ovarian, lung, cancer, aml, tobin, cgd,
heart, kidney, logan, nwtco, pbc, rats in survival


\section{Model fitting syntax} 

The main model-fitting function is called \code{flexsurvreg}.  Its
first argument is an R \emph{formula} object.  The left hand side of
the formula gives the response as a survival object using \code{Surv}
function from the \pkg{survival} package.  Here, this indicates that
the response variable is \code{recyrs}, and that these are observed
death and censoring times when the variable \code{censrec} is 1 or 0
respectively.  All of these variables are in the data frame called
\code{bc}.  
<<eval=FALSE>>=
library(flexsurv)
flexsurvreg(Surv(recyrs, censrec) ~ group, data=bc, dist="weibull")
survreg(Surv(recyrs, censrec) ~ group, data=bc, dist="weibull")
@ 

If we also had left-truncation times in a variable called
\code{start}, the response would be \\ \code{Surv(start,recyrs,censrec)}.
Or if all responses were interval-censored between lower and upper
bounds \code{tmin} and \code{tmax}, then we would write
\code{Surv(tmin,tmax,type="interval2")}.



\subsection{Using a built-in survival model}

If the argument \code{dist} is a string, this denotes a built-in
survival distribution.  The currently built-in distributions are
listed in Table \ref{tab:dists}.  In each case, the probability
density $f()$ and parameters used in the fitted model is taken from an
existing R function of the same name but beginning with the letter
\code{d}.  For example if \code{dist="weibull"}, the density function
is \code{dweibull}.

For the Weibull, exponential (\code{dexp}), gamma (\code{dgamma}) and
log-normal (\code{dlnorm}), the density functions are provided with
standard installations of R.  For all built-in distributions,
\pkg{flexsurv} also defines functions beginning \code{h} giving the
hazard, and \code{H} for cumulative hazard.

Illustrate survreg and flexsurvreg, par ests come from dweibull.
<<>>=
@ 

\pkg{flexsurv} provides some additional survival distributions
including the Gompertz distribution with unrestricted shape parameter
(\code{dist="gompertz"}), and two more flexible families:

\paragraph{Generalized gamma} This three-parameter distribution
includes the Weibull, gamma and log-normal as special cases.  The
original parameterisation from \citet{stacy:gengamma} is available as\\
\code{dist="gengamma.orig"}, however the newer parameterisation
\citep{prentice:loggamma} is preferred: \code{dist="gengamma"}.  This has
parameters ($\mu$,$\sigma$,$q$), and survivor function
\[
\begin{array}{ll}
1 - I(\gamma,u)   & (q > 0)\\
1 - \Phi(z)  & (q = 0)\\
\end{array}
\]
where $I(a,x) = \int_0^x x^{a-1}\exp(-x)/\Gamma(a)$ is the incomplete gamma function (the cumulative gamma distribution with shape $a$ and scale 1), $\Phi$ is the standard normal cumulative distribution,  $u = \gamma \exp(|q|z)$, $z=(\log(t) - \mu)/\sigma$, and $\gamma=q^{-2}$.   The \citet{prentice:loggamma} parameterisation extends the original one to include a further class of models with negative $q$, and survivor function $I(\gamma,u)$, where $z$ is replaced by $-z$.   This stabilises estimation when the distribution is close to log-normal, since $q=0$ is no longer near the boundary of the parameter space.    In R notation, \footnote{The parameter called $q$ here and in previous literature is called $Q$ in \code{dgengamma} and related functions, since the first argument of a cumulative distribution function is conventionally named \code{q}, for quantile, in R.} the parameter values corresponding to the three special cases are

\begin{Code}
dgengamma(x, mu, sigma, Q=0)     ==  dlnorm(x, mu, sigma)                                
dgengamma(x, mu, sigma, Q=1)     ==  dweibull(x, shape=1/sigma, scale=exp(mu))           
dgengamma(x, mu, sigma, Q=sigma) ==  dgamma(x, shape=1/sigma^2, 
                                               rate=exp(-mu) / sigma^2)  
\end{Code}


\paragraph{Generalized F} This four-parameter distribution includes
the generalized gamma, and also the log-logistic, as special cases.
The variety of hazard shapes that can be represented is discussed by
\citet{ccox:genf}.  It is provided here in alternative ``original''
(\code{dist="genf.orig"}) and ``stable'' parameterisations
(\code{dist="genf"}) as presented by \citet{prentice:genf}. 
See \code{help(GenF)} and \code{help(GenF.orig)} in the package documentation 
for the exact definitions.


\begin{table}
  \begin{tabular}{llll}
\hline
    &  Parameters &  Density R function & \code{dist}\\
\hline
    Exponential & rate             & dexp   & \code{"exp"} \\
    Weibull     & shape, scale     & dweibull & \code{"weibull"} \\
    Gamma       & shape, rate      & dgamma & \code{"gamma"}\\
    Log-normal  & meanlog, sdlog   & dlnorm & \code{"lnorm"}\\
    Gompertz    & shape, rate      & dgompertz & \code{"gompertz"} \\
    Generalized gamma (Prentice 1975)   & & dgengamma & \code{"gengamma"} \\
    Generalized gamma (Stacy 1962)& & dgengamma & \code{"gengamma.orig"} \\
    Generalized F     (stable)    & & dgenf & \code{"genf"} \\
    Generalized F     (original)  & & dgenf & \code{"genf.orig"} \\
\hline
  \end{tabular}
  \caption{Built-in parametric survival distributions in \pkg{flexsurv}}
  \label{tab:dists}
\end{table}


%% what do we want to show for outputs? 
%% covariate effects, on more than one parameter. 
%% plot methods, but no need to show output from summary
%% using the generalized gamma, eff on 2 but not 3

\subsection{Supplying own distributions}

\pkg{flexsurv} is not limited to its built-in distributions.  Any
survival model of the form (\ref{eq:model}--\ref{eq:lik}) can be
fitted if we can provide either the density function $f()$ or the hazard $h()$.
Many contributed R packages provide probability density and cumulative
distribution functions for positive distributions.  On the other hand,
survival models are naturally specified by through their hazard
function, representing the changing risk of death through time.  For
example, for survival following major surgery we may want a
``U-shaped'' hazard curve, representing a high risk soon after the
operation, which then decreases, but increases naturally as survivors
grow older.

    
\paragraph{Example: Using functions from a contributed package}

Distribution exists in another package, but may be parameterised 
Example: Gompertz-Makeham
Functions need to be vectorised 

\paragraph{Example: Changing the parameterisation of a distribution}

(talk about Weibull prop haz model, GG PH)
refer back to Weibull model presentation
refer back to GG presentation 

\paragraph{Example: Omitting the cumulative distribution or hazard}

If there is no analytic form for $F(t)$ or $H(t)$ as the integral of
the density or hazard respectively, then \pkg{flexsurv} can compute
these internally by numerical integration, though this will
substantially slow down the computation.  The default options of the
built-in R routine \code{integrate} for adaptive quadrature are used,
though these may be changed using the \code{integ.opts} argument to
\code{flexsurvreg}.


In Section \ref{sec:gdim} 


\subsection{Computation}

The likelihood is maximised using the optimisation methods available
through the standard R \code{optim} function.  By default, this is the
\code{"BFGS"} method (\citep{nash}) which can use the analytic
derivatives of the likelihood with respect to the model parameters, if
these are available, to improve the speed of convergence to the
maximum.

For custom distributions, the user can optionally supply functions
with names beginning \code{"DLd"} and \code{"DLS"} respectively
(e.g. \code{DLdweibull,DLSweibull}) to calculate the derivatives of
the log density and log survivor functions with respect to the
transformed parameters $\gamma$.

Initial values are difficult: ideally two would come from moments of
the distribution, then defaults that reduce to simpler distributions.
example

Demo on at least one dataset: stgenreg uses bc example i think




\subsection{Output functions}

\code{summary.flexsurvreg} calculates the estimated survival, hazard
or cumulative hazard at a series of times and for specified covariate
values. Confidence intervals are produced by simulating a large sample
from the asymptotic normal distribution of the maximum likelihood
estimates $\gamma$ OR WHATEVER, via the function
\code{normboot.flexsurvreg}.  The default \code{plot} method for
\code{flexsurvreg} objects graphs these fitted trajectories against
non-parametric estimates based on Kaplan-Meier or kernel estimation
(REF muhaz), while the \code{lines} method adds lines to an existing
plot.  REFER TO EXAMPLE FIGURE

Any user-defined function of the basic model parameters $\gamma$ OR
WHATEVER and time can also be summarised in the same way.  For
example, in a non-proportional hazards model, the hazard ratio between
two groups of interest varies through time.  To plot this trajectory,
and confidence intervals.   EXAMPLE FROM SPLINE. 

Restricted mean survival: say of interest. ref royston + parmar


\section{Any-dimension models}

\pkg{flexsurv} also supports models where the number of parameters is
arbitrary.  In the models discussed previously, the number of
parameters in the model family is fixed (e.g. three for the
generalized gamma).  Here the model complexity can be chosen by the
user.  We may want to represent more irregular hazard
curves by more flexible functions, or use bigger models if a bigger
sample size makes it feasible to estimate more parameters.


\subsection{Royston and Parmar spline model}

In the spline-based survival model of \citet{royston:parmar}, a
transformation $g(S(t,z))$ of the survival function is modelled as a
natural cubic spline function of log time, $x = \log(t)$, plus linear
effects of covariates $z$.  This is available here as the function
\code{flexsurvspline},  and is also available in the Stata package
\code{stpm2} \citep{stpm2} (and historically \code{stpm}, \citet{stpm:orig,stpm:update}).

  \[g(S(t,z)) = s(x, \bm{\gamma})\]

Typically we use $g(S(t,\mathbf{z}) = \log(-\log(S(t,\mathbf{z}))) =
\log(H(t,\mathbf{z}))$, the log cumulative hazard, giving a
proportional hazards model.    

\paragraph{Spline parameterisation}
The complexity of the model, thus the dimension of $\bm{\gamma}$, is
governed by the number of \emph{knots} $m$ in the spline function
$s()$.  Natural cubic splines are piecewise cubic polynomials defined
to be continuous, with continuous first and second derivatives at the
knots, and also constrained to be linear beyond boundary knots
$k_{min},k_{max}$.  As well as the boundary knots there may be up to
$m\geq 0$ \emph{internal} knots $k_1,\ldots k_m$.  Various spline
parameterisations exist --- the one used here is from
\citet{royston:parmar}.
\begin{equation}
  \label{eq:spline}
  s(x,\bm{\gamma}) = \gamma_0 + \gamma_1 x + \gamma_2 v_1(x) + \ldots + \gamma_{m+1} v_m(x)   
\end{equation}


where $v_j(x)$ is the $j$th \emph{basis} function

\[v_j(x) = (x - k_j)^3_+ - \lambda_j(x - k_{min})^3_+ - (1 - \lambda_j) (x - k_{max})^3_+, 
\qquad
\lambda_j = \frac{k_{max} - k_j}{k_{max} - k_{min}} \] 

and $(x - a)_+ = max(0, x - a)$.  If $m=0$ then there are only two
parameters $\gamma_0,\gamma_1$ --- in fact if $g()$ is the log
cumulative hazard, this is equivalent to a Weibull model (PARAMETERS /
DPQR STATEMENT).  Table \ref{tab:spline} explains two alternative
choices of $g()$.
  
  \begin{table}
  \begin{tabularx}{\textwidth}{lXll}
\hline
    Model &  $g(S(t,\mathbf{z}))$ & In \code{flexsurvspline} & With $m=0$ \\
\hline
    Proportional hazards & $\log(-\log(S(t,\mathbf{z})))$ \newline {\footnotesize (log cumulative hazard)}  & \code{scale="hazard"} & Weibull\\
    Proportional odds    & $\log(S(t,\mathbf{z})^{-1} - 1)$ \newline {\footnotesize (log cumulative odds)}   & \code{scale="odds"} & Log-logistic\\
    Normal / probit      & $\Phi^{-1}(S(t,\mathbf{z}))$  \newline   {\footnotesize (inverse normal CDF, \code{qnorm})}    & \code{scale="normal"} & Log-normal \\  
\hline
  \end{tabularx}    
    \caption{Alternative modelling scales for \code{flexsurvspline}}
    \label{tab:spline}
\end{table}

\paragraph{Covariates on spline parameters}
Covariates can be placed on any parameter $\gamma$ through a linear
model (with identity link function).  Most straightforwardly we can
let the intercept $\gamma_0$ vary with covariates $\mathbf{z}$, giving
a proportional hazards or odds model (depending on $g()$).

\[g(S(t,z)) = s(x, \bm{\gamma}) + \bm{\beta}^T \mathbf{z} \]

FLEXSURVSPLINE COMMAND

The spline coefficients $\gamma_j: j=1, 2 \ldots$, the "ancillary parameters",
may also be modelled as linear functions of covariates $\mathbf{z}$, as

\[\gamma_j(\mathbf{z}) = \gamma_{j0} + \gamma_{j1}z_1 + \gamma_{j2}z_2 + \ldots\]

giving a model where the effects of covariates are arbitrarily flexible
functions of time: a non-proportional hazards or odds model.

FLEXSURVSPLINE COMMAND

Demo on at least one dataset 

DPQR STATEMENTS


\subsection{General-dimension models}
\label{sec:gdim}

The spline model above is an example of the general parametric form
(\ref{eq:model}), but the number of parameters ($R+1$ in
(\ref{eq:model}), $m+2$ in (\ref{eq:spline})) is arbitrary.
\pkg{flexsurv} has the tools to deal with any model of this form.

The R distribution functions supplied to custom models are expected to
have a fixed number of arguments, one for each scalar parameter.  The
distribution functions for the spline model have an argument
\code{gamma} representing the vector of parameters $\gamma$.

Due to vectorisation:  EXAMPLE

utility \code{unroll.function} which creates


\paragraph{Splines on alternative scales}

stgenreg has demo of spline modelling on the log hazard scale.  Can we do this using a generic distribution? 
(advantage: when there are multiple time dependent effects, the
interpretation of the time-dependent hazard ratios is simplified as
they do not depend on values of other covariates, which is the case
when modelling on the cumulative hazard scale (Royston and Lambert
2011).

\paragraph{Fractional polynomials}

%fractional polynomials? 
%specified by number M and set of powers p1,...pM
%chosen from c(-2,-1,-0.5,0,0.5,1,2,3), including repeats, where x^0 = log(x)
%with repeated powers, each repeat multiplied by a power of log(x)

relation to fractional polynomials 
(see \pkg{mfp} for continuous covariates, slightly diff)


\section{Multi-state models}

enhances mstate

% cif in comp risks planned for stgenreg 
\section{Potential extensions}

relative survival
frailty 
many extensions may come from user-contributed models


\appendix
\section{Acknowledgements}
Thanks to Milan Bouchet-Valat.

\bibliography{flexsurv}

\end{document}
